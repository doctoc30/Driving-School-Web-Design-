<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RedWalk 3D Cinematic Walkthrough</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Lato&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Lato',sans-serif; background:#111; color:#fff; }
h1,h2,h3,h4,h5,h6 { font-family:'Montserrat',sans-serif; }
header { background:#c62828; color:#fff; padding:25px 15px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
header h1 { margin:0; font-size:2rem; letter-spacing:1px; }
header p { margin:5px 0 0 0; font-size:1rem; opacity:0.9; }

.container { max-width:1200px; margin:auto; padding:20px; display:flex; flex-direction:column; gap:20px; }
.upload-area {
  border:2px dashed #c62828; border-radius:15px; padding:40px; text-align:center;
  font-size:1.2rem; font-weight:bold; color:#c62828; transition:0.3s; cursor:pointer;
  background: rgba(255,255,255,0.05); box-shadow:0 5px 15px rgba(0,0,0,0.2);
}
.upload-area.dragover { background: rgba(198,40,40,0.2); transform: scale(1.03); }

.main-view { display:flex; flex-direction:column; gap:15px; width:100%; }
.active-image-container { width:100%; text-align:center; position:relative; }
#activeImage { width:100%; max-height:70vh; object-fit:cover; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,0.6); }
#activeTextarea { width:90%; margin:10px auto 0 auto; padding:12px; border-radius:12px; border:none; outline:none;
  resize:none; font-size:1rem; background: rgba(255,255,255,0.1); color:#fff; box-shadow:0 3px 15px rgba(0,0,0,0.5);
}
#activeTextarea:focus { background: rgba(255,255,255,0.2); }

#thumbnails { display:flex; overflow-x:auto; gap:10px; padding-bottom:10px; }
#thumbnails img { width:80px; height:55px; object-fit:cover; border-radius:10px; cursor:pointer; border:2px solid transparent; transition:0.3s; }
#thumbnails img.active { border:2px solid #c62828; transform:scale(1.05); }

button { background: linear-gradient(45deg, #c62828, #ff5252); color:#fff; border:none; padding:12px 20px; margin:8px auto;
  border-radius:12px; font-size:1rem; cursor:pointer; width:90%; transition:0.3s; box-shadow:0 5px 15px rgba(0,0,0,0.3);
}
button:hover { transform: translateY(-2px); box-shadow:0 7px 20px rgba(0,0,0,0.4); }

#canvasContainer { width:100%; height:450px; border-radius:15px; overflow:hidden; margin-top:20px; box-shadow:0 5px 20px rgba(0,0,0,0.5); }

@media(min-width:900px){
  .main-view { flex-direction:row; }
  .active-image-container { flex:2; }
  #thumbnails { flex-direction:column; overflow-y:auto; max-height:70vh; }
  #thumbnails img { width:100px; height:70px; }
}
</style>
</head>
<body>

<header>
  <h1>RedWalk 3D Cinematic Walkthrough</h1>
  <p>Create cinematic property videos with narration</p>
</header>

<div class="container">
  <div class="upload-area" id="uploadArea">Tap or drag photos here</div>
  <input type="file" id="fileInput" multiple accept="image/*" style="display:none;">

  <div class="main-view">
    <div class="active-image-container">
      <img id="activeImage" src="" alt="Active Property Image">
      <textarea id="activeTextarea" placeholder="Add few words describing this image for narration..."></textarea>
    </div>
    <div id="thumbnails"></div>
  </div>

  <button id="generateScript">Generate Script</button>
  <button id="playNarration">Play Narration</button>
  <button id="generateVideo">Generate Video</button>

  <div id="canvasContainer"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.16.0/Sortable.min.js"></script>

<script>
let photos = [], activeIndex = 0, script = [];
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const thumbnails = document.getElementById('thumbnails');
const activeImage = document.getElementById('activeImage');
const activeTextarea = document.getElementById('activeTextarea');
const container = document.getElementById('canvasContainer');

// Upload images
uploadArea.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', handleFiles);
uploadArea.addEventListener('dragover', e=>{ e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', e=>{ uploadArea.classList.remove('dragover'); });
uploadArea.addEventListener('drop', e=>{ e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer); });

function handleFiles(e){
  const files = e.files || e.target.files;
  for(let file of files){
    if(!file.type.startsWith('image/')) continue;
    const reader = new FileReader();
    reader.onload = function(ev){
      photos.push({src: ev.target.result, text: ''});
      renderThumbnails();
      setActiveImage(photos.length-1);
    }
    reader.readAsDataURL(file);
  }
}

// Render thumbnails
function renderThumbnails(){
  thumbnails.innerHTML = '';
  photos.forEach((p,i)=>{
    const img = document.createElement('img');
    img.src = p.src;
    if(i===activeIndex) img.classList.add('active');
    img.addEventListener('click', ()=>setActiveImage(i));
    thumbnails.appendChild(img);
  });
}

// Set active image
function setActiveImage(index){
  activeIndex = index;
  activeImage.src = photos[index].src;
  activeTextarea.value = photos[index].text;
  const thumbImgs = thumbnails.querySelectorAll('img');
  thumbImgs.forEach((t,i)=>t.classList.toggle('active', i===index));
}

// Save textarea changes immediately
activeTextarea.addEventListener('input', ()=>{
  photos[activeIndex].text = activeTextarea.value;
});

// Reordering thumbnails
Sortable.create(thumbnails, {
  animation:150,
  onEnd: function(evt){
    const newPhotos = [];
    const thumbImgs = thumbnails.querySelectorAll('img');
    thumbImgs.forEach(img=>{
      const found = photos.find(p=>p.src===img.src);
      if(found) newPhotos.push(found);
    });
    photos = newPhotos;
    const activeSrc = activeImage.src;
    activeIndex = photos.findIndex(p=>p.src===activeSrc);
    renderThumbnails();
    setActiveImage(activeIndex);
  }
});

// Generate script
document.getElementById('generateScript').addEventListener('click', ()=>{
  photos[activeIndex].text = activeTextarea.value;
  script = photos.map((p,i)=>p.text || `Slide ${i+1} default description`);
  alert('Script generated for '+script.length+' slides.');
});

// TTS playback synced with cinematic
async function playCinematicTTS(){
  if(!script.length){ alert('Generate script first'); return; }
  if(!photos.length){ alert('Upload photos first'); return; }

  // Three.js scene setup
  const scene = new THREE.Scene();
  const width=container.clientWidth, height=container.clientHeight;
  const camera = new THREE.PerspectiveCamera(50, width/height, 0.1, 1000);
  camera.position.z=5;
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(width,height);
  container.innerHTML=''; container.appendChild(renderer.domElement);
  scene.add(new THREE.AmbientLight(0xffffff,1));

  const planes=[];
  for(let p of photos){
    const img = new Image(); img.src=p.src;
    const tex = new THREE.Texture(img); tex.needsUpdate=true;
    const geom = new THREE.PlaneGeometry(4,2.25);
    const mat = new THREE.MeshBasicMaterial({map:tex});
    const plane = new THREE.Mesh(geom,mat);
    planes.push(plane);
    scene.add(plane);
  }

  renderer.render(scene,camera);

  for(let i=0;i<planes.length;i++){
    // Animate camera to plane
    const targetZ = -i*5;
    await animateCamera(camera, targetZ, renderer, scene);

    // Speak the text for this image
    await speakText(script[i]);
  }
}

function animateCamera(camera, targetZ, renderer, scene){
  return new Promise(resolve=>{
    const duration = 2000;
    const startZ = camera.position.z;
    const startTime = performance.now();
    function step(time){
      const elapsed = time-startTime;
      const t = Math.min(elapsed/duration,1);
      camera.position.z = startZ + (targetZ-startZ)*t;
      renderer.render(scene,camera);
      if(t<1) requestAnimationFrame(step);
      else resolve();
    }
    requestAnimationFrame(step);
  });
}

function speakText(text){
  return new Promise(resolve=>{
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate=1; utter.pitch=1;
    utter.onend = resolve;
    speechSynthesis.speak(utter);
  });
}

document.getElementById('playNarration').addEventListener('click', playCinematicTTS);

// Video generation remains similar to previous prototype
document.getElementById('generateVideo').addEventListener('click', ()=>{
  alert('Video export for cinematic version requires additional server-side or advanced client-side capture implementation.');
});
</script>
</body>
</html>
