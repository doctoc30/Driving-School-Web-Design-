<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RedWalk 3D Cinematic Walkthrough</title>
<style>
body { margin:0; font-family: Arial,sans-serif; background:#fff; color:#222; }
header { background:#c62828; color:#fff; padding:15px; text-align:center; }
header h1 { margin:0; font-size:1.8rem; }
.container { padding:10px; max-width:900px; margin:auto; }
.upload-area { border:2px dashed #c62828; padding:20px; text-align:center; color:#c62828; margin-bottom:10px; cursor:pointer; border-radius:5px; }
.upload-area.dragover { background:#ffcdd2; }
#fileInput { display:none; }
#thumbnails { display:flex; overflow-x:auto; gap:10px; margin-bottom:10px; }
.slide-container { display:flex; flex-direction:column; align-items:center; margin-bottom:10px; }
.slide-container img { width:100px; height:70px; object-fit:cover; border:2px solid #c62828; border-radius:5px; cursor:pointer; }
.slide-container textarea { width:90%; padding:8px; margin-top:5px; border:2px solid #c62828; border-radius:5px; display:none; resize:none; }
button { background:#c62828; color:#fff; border:none; padding:10px 15px; margin:5px 0; border-radius:5px; font-size:1rem; width:100%; }
button:hover { background:#ff5252; }
#canvasContainer { width:100%; margin-top:10px; height:360px; }
canvas { width:100%; height:100%; display:block; border:2px solid #c62828; border-radius:5px; }
@media(max-width:600px){
  .slide-container img { width:80px; height:60px; }
  .slide-container textarea { font-size:0.9rem; }
}
</style>
</head>
<body>

<header>
<h1>RedWalk 3D Walkthrough</h1>
<p>Create cinematic property videos with narration</p>
</header>

<div class="container">
<div class="upload-area" id="uploadArea">Tap or drag photos here</div>
<input type="file" id="fileInput" multiple accept="image/*">

<div id="thumbnails"></div>

<button id="generateScript">Generate Script</button>
<button id="playNarration">Play Narration</button>
<button id="generateVideo">Generate Video</button>

<div id="canvasContainer"></div>
</div>

<!-- Three.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<!-- Sortable.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.16.0/Sortable.min.js"></script>

<script>
let photos = [];
let script = [];
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const thumbnails = document.getElementById('thumbnails');
const container = document.getElementById('canvasContainer');

// Upload & preview
uploadArea.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', handleFiles);
uploadArea.addEventListener('dragover', e=>{ e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', e=>{ uploadArea.classList.remove('dragover'); });
uploadArea.addEventListener('drop', e=>{ e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer); });

function handleFiles(e){
  const files = e.files || e.target.files;
  for(let file of files){
    if(!file.type.startsWith('image/')) continue;
    const reader = new FileReader();
    reader.onload = function(ev){
      const img = new Image(); img.src = ev.target.result;
      img.onload = ()=>photos.push(img);

      // Create slide container
      const slideDiv = document.createElement('div');
      slideDiv.classList.add('slide-container');

      const thumb = document.createElement('img');
      thumb.src = ev.target.result;

      const ta = document.createElement('textarea');
      ta.placeholder = "Add a few words describing this image for narration...";

      // Click thumbnail to toggle textarea
      thumb.addEventListener('click', ()=>{
        const allTAs = document.querySelectorAll('.slide-container textarea');
        allTAs.forEach(t=>t.style.display='none'); // hide others
        ta.style.display = 'block';
        ta.focus();
      });

      slideDiv.appendChild(thumb);
      slideDiv.appendChild(ta);
      thumbnails.appendChild(slideDiv);
    }
    reader.readAsDataURL(file);
  }
}

// Drag-and-drop ordering
Sortable.create(thumbnails, {
  animation:150,
  onEnd: function(evt){
    const reordered = [];
    thumbnails.querySelectorAll('.slide-container img').forEach(img=>{
      const found = photos.find(p=>p.src===img.src);
      if(found) reordered.push(found);
    });
    photos = reordered;
  }
});

// Generate script based on each textarea
document.getElementById('generateScript').addEventListener('click', ()=>{
  script = [];
  document.querySelectorAll('.slide-container textarea').forEach((ta,i)=>{
    const text = ta.value || `Slide ${i+1} default description`;
    script.push(text);
  });
  alert('Script generated for '+script.length+' slides.');
});

// Play narration
document.getElementById('playNarration').addEventListener('click', ()=>{
  if(!script.length){ alert('Generate script first'); return; }
  const utterance = new SpeechSynthesisUtterance(script.join('. '));
  utterance.rate = 1; utterance.pitch = 1;
  speechSynthesis.speak(utterance);
});

// ------------------ Three.js Setup ------------------
let scene, camera, renderer;
let planes = [];

function initThree(){
  scene = new THREE.Scene();
  const width = container.clientWidth;
  const height = container.clientHeight;
  camera = new THREE.PerspectiveCamera(50, width/height, 0.1, 1000);
  camera.position.z = 5;

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(width, height);
  container.innerHTML = '';
  container.appendChild(renderer.domElement);

  const light = new THREE.AmbientLight(0xffffff,1);
  scene.add(light);

  // Clear previous planes
  planes = [];

  // Load textures
  photos.forEach((img,i)=>{
    const tex = new THREE.Texture(img);
    tex.needsUpdate = true;
    const geometry = new THREE.PlaneGeometry(4,2.25);
    const material = new THREE.MeshBasicMaterial({map:tex});
    const plane = new THREE.Mesh(geometry,material);
    plane.position.z = -i*5;
    scene.add(plane);
    planes.push(plane);
  });
}

// Animate camera
let animating = false;
function animateCamera(){
  if(animating) return;
  animating = true;
  let i=0;
  function moveNext(){
    if(i>=planes.length) { animating=false; return; }
    const targetZ = -i*5;
    const duration = 3000; // 3s per slide
    const startZ = camera.position.z;
    const startTime = performance.now();
    function step(time){
      const elapsed = time - startTime;
      const t = Math.min(elapsed/duration,1);
      camera.position.z = startZ + (targetZ - startZ)*t;
      renderer.render(scene,camera);
      if(t<1) requestAnimationFrame(step);
      else { i++; moveNext(); }
    }
    requestAnimationFrame(step);
  }
  moveNext();
}

// Generate video
document.getElementById('generateVideo').addEventListener('click', async ()=>{
  if(!photos.length){ alert('Upload photos first'); return; }
  initThree();
  animateCamera();
  const stream = renderer.domElement.captureStream(30);
  const recorder = new MediaRecorder(stream);
  let chunks=[];
  recorder.ondataavailable = e=>chunks.push(e.data);
  recorder.onstop = ()=>{
    const blob = new Blob(chunks,{type:'video/webm'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='property-video.webm'; a.click();
  };
  recorder.start();
  setTimeout(()=>recorder.stop(), photos.length*3000 + 500);
});
</script>

</body>
</html>
